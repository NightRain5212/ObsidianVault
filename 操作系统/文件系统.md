
# 概论

- **文件**是进程创建的信息逻辑单元。可以把每一个文件看作一个地址空间。
- 存储在文件的信息必须是持久的，不会因为进程的创建和终止而影响。
- 文件受操作系统管理，**操作系统中处理文件的部分为文件系统**。

# 文件

## 文件命名

- 文件名以`.`分割为两部分，前面为文件名，后面为文件扩展名。
- 文件扩展名表示文件的一些信息，如文件类型等。

## 文件结构

![fXcHkhGNpIyx75J.png](https://s2.loli.net/2025/12/08/fXcHkhGNpIyx75J.png)

### 字节序列

- 把文件看成字节序列/字节流。为操作系统提供了很大的灵活性。

### 记录序列

- 文件是具有固定长度记录的序列。每个记录都有内部结构。操作时以一个记录为单位进行操作。

### 记录树

- 文件由一棵记录树构成。每个记录不必有固定的长度。 记录的固定位置上有一个键字段。这棵树按键字段进行排序，从而可以对键字段进行快速查找。 

## 文件类型

- **普通文件**：包含有用户信息的文件。（ascii文件，二进制文件）
- **目录**：管理文件系统结构的系统文件。
- **字符特殊文件**：用于串行IO设备
- **块特殊文件**：用于磁盘类文件

## 文件属性

- 文件的附加信息：文件的创建日期，大小等，称为**文件属性**，也称为**元数据**。
![b38IzOJpfhHcaRP.png](https://s2.loli.net/2025/12/08/b38IzOJpfhHcaRP.png)
- 前4个属性与文件保护有关。
- 标志是一些位或短字段，用于控制或启用某些特殊属性。
- 记录长度，键的位置，键的长度只能出现在用关键字查找记录的文件里，它们提供了查找关键字所需的信息。

## 文件访问

### 顺序访问

- 从头按顺序存取文件的全部字节或记录。
- 不能跳过某些内容，可以返回到起点，或者多次存取。
- 当存储介质为磁带时，顺序存取方式非常合适的。

### 随机访问

- 可以以任何次序存取文件的字节或者记录。（不按顺序地读取，或按关键字访问记录）
- 对于数据库系统，这种存取方式是必不可少的
- 有两种方法可以指示从何处开始读写文件：
	- 每次读写操作都给出开始读写文件的位置
	- 用一个seek操作设置当前读写位置，然后从此位置开始顺序读写文件。

## 文件操作

- Create：创建不包含任何数据的文件
- Delete：删除文件释放磁盘空间
- Open：在使用文件之前，必须先打开文件。
- Close：访问结束后，关闭文件释放内部表空间
- Read：在文件中读取数据
- Write：向文件写数据
- Append：在文件末尾追加数据
- Seek：指定从何处开始读取数据
- Get Attributes：读取文件属性
- Set Attributes：设置文件属性
- Rename：重命名

# 目录

## 单级目录系统

- 目录的最简单形式是在一个目录中包含所有的文件，称为根目录。

![kfJHEonBCWPLmul.png](https://s2.loli.net/2025/12/08/kfJHEonBCWPLmul.png)
## 层次目录系统

- 可以用很多目录对文件进行分组。

![FnZhcvqu4z3Qwm9.png](https://s2.loli.net/2025/12/08/FnZhcvqu4z3Qwm9.png)

## 路径名

- 用目录树组织文件系统时，需要用路径名指向特定文件。
- 绝对路径：从根目录到文件的路径组成，如：`/usr/jim/aaa`
- 相对路径：即相对于工作目录的路径。如果当前工作目录为`/usr/ast`，则`/usr/ast/aaa`的文件路径名可以写成相对路径`aaa`

# 文件系统布局

![FbAaONQtz34cEvf.png](https://s2.loli.net/2025/12/08/FbAaONQtz34cEvf.png)

- 磁盘的0号扇区为**主引导目录**（MBR），用来引导计算机。
- 在MBR的结尾是**分区表，给出了每个分区的起始和结束地址。** 表中的一个分区为活动分区。
- 在计算机被引导时，BIOS读入并执行MBR，MBR做的第一件事是确定活动分区，读入它的第一个块，称为引导块，并执行。引导块中的程序装载该分区的操作系统。
- 超级块(*superblock*)：包含文件系统的所有关键参数。
- 空闲块信息块：位图或指针列表
- i节点：说明了文件的各种信息，属性。
- 根目录/文件与目录。



# 文件的实现

- 文件的物理结构是指**文件数据盘块在硬盘等存储介质中的组织方式**，有**连续存储方式和离散存储方式**两种。

### 连续分配

![qU6DFLbYVmMek8s.png](https://s2.loli.net/2025/12/08/qU6DFLbYVmMek8s.png)

- 把每一个文件作为一连串连续数据块存储在磁盘上。
- **优点**：
	- 实现简单，只需记录第一块的磁盘地址和文件块数即可。
	- 相对于其他文件物理结构，**存取速度最快**。
- **缺点**：
	- 磁盘会产生很多**空闲碎片**，不能充分利用磁盘空间。
	- **不支持文件的动态增长**

### 链表分配

![rNlU8pEdDmcFMfO.png](https://s2.loli.net/2025/12/08/rNlU8pEdDmcFMfO.png)

- 为每个文件构造**磁盘块链表**。每个块的第一个字作为指向下一块的指针，其他部分存放数据。
- **优点**：
	- 采用离散式分配，能**充分利用磁盘空**间（**不产生外部碎片**，文件的最后一块可能有内部空余）。
	- **支持文件的动态增长**
- **缺点**：
	- 随机访问十分缓慢，因为每一次必须从头开始一直读到想要读的那一块。

### 使用内存中的表（文件分配表）进行分配

![IJa6Efx315KewyU.png](https://s2.loli.net/2025/12/08/IJa6Efx315KewyU.png)

- **取出每个磁盘块的指针字，把它们放在内存的一个表中。** 这个表就是**文件分配表**(File Allocation Table，FAT)
- 利用文件分配表，可以直接找到对应文件的起始块，顺着链往下找即可找到全部文件。
- 优点：
	- **支持随机访问**。
- 缺点：
	- **必须把整个表存在内存中**，对大型磁盘不能较好支持。

### 索引文件分配

![tQqC2iJglvNzAcn.png](https://s2.loli.net/2025/12/08/tQqC2iJglvNzAcn.png)

- 给每个文件建立一个索引文件，记录每个文件块的磁盘地址（物理块号）。
- 根据索引文件，就可以找到文件的所有文件块。
- 假设物理块大小为4KB，索引表指针为4个字节
	- 能管理的最大文件：`1K(4KB/4个目录项)*4KB(每个目录项对应的物理块大小)=4MB`
	- 磁盘IO操作次数：`1(访问索引文件)+1(访问物理块)`

- 类似地，索引文件也可以建立多级索引文件。

![Q5vVt6DLBqmKU2E.png](https://s2.loli.net/2025/12/08/Q5vVt6DLBqmKU2E.png)
- 假设物理块大小为4KB，索引表指针为4个字节
	- 能管理的最大文件：`1K(4KB/4 个二级索引项)*1K(4KB/4 个目录项)*4KB(每个目录项对应的物理块大小)=4GB`
	- 磁盘IO操作次数：`1(访问一级索引)+1(访问二级索引文件)+1(访问物理块)`

## 文件的存取方法

![1HdfEQ3n8M6PwyX.png](https://s2.loli.net/2025/12/08/1HdfEQ3n8M6PwyX.png)


### UNIX文件

 - 直接间接混合寻址方式
- 一共分为13个块：前10个块为直接索引，第11为一级索引，12为二级索引，13为三级索引
![SOBc6irVyHMQwP4.png](https://s2.loli.net/2025/12/08/SOBc6irVyHMQwP4.png)

# 目录的实现

- 目录系统的主要功能是把文件名映射成定位文件数据所需的信息。

![VBrNmM78RDlEz2H.png](https://s2.loli.net/2025/12/15/VBrNmM78RDlEz2H.png)
## 简单设计方案(a)

- 目录有一个**固定大小**的目录项列表，每个文件对应一项。包含一个固定长度的文件名，一个文件属性的结构体，以及用以说明磁盘块位置的磁盘地址。
- 特点：
	- **固定大小的目录项**
	- **目录项中包含文件的所有属性**

## 索引节点(i-node)方案(b)

- 文件名和其他属性分离，**目录项中只有文件名和文件索引节点号**。
- **文件的属性均在其对应的索引节点中**


# 共享文件


