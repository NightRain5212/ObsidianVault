
# 概论

- **文件**是进程创建的信息逻辑单元。可以把每一个文件看作一个地址空间。
- 存储在文件的信息必须是持久的，不会因为进程的创建和终止而影响。
- 文件受操作系统管理，**操作系统中处理文件的部分为文件系统**。

# 文件

## 文件命名

- 文件名以`.`分割为两部分，前面为文件名，后面为文件扩展名。
- 文件扩展名表示文件的一些信息，如文件类型等。

## 文件结构

![fXcHkhGNpIyx75J.png](https://s2.loli.net/2025/12/08/fXcHkhGNpIyx75J.png)

### 字节序列

- **把文件看成字节序列/字节流**。为操作系统提供了很大的灵活性。
- 文件中的数据**由一系列二进制流或字符流组成**，“流式文件”，也称**无结构文件**。

### 记录序列

- **文件是具有固定长度记录的序列**。每个记录都有内部结构。操作时以一个记录为单位进行操作。
- 根据记录长度是否相等，分为**定长记录**和**可变长记录**。
- 每条记录有一个数据项可作为**关键字**。

### 记录树

- 文件由一棵记录树构成。每个记录不必有固定的长度。 **记录的固定位置上有一个键字段。**这棵树按键字段进行排序，从而可以对键字段进行快速查找。 

## 文件类型

- **普通文件**：包含有用户信息的文件。（ascii文件，二进制文件）
- **目录**：管理文件系统结构的系统文件。
- **字符特殊文件**：用于串行IO设备
- **块特殊文件**：用于磁盘类文件

## 文件属性

- 文件的附加信息：文件的创建日期，大小等，称为**文件属性**，也称为**元数据**。
![b38IzOJpfhHcaRP.png](https://s2.loli.net/2025/12/08/b38IzOJpfhHcaRP.png)
- 前4个属性与文件保护有关。
- 标志是一些位或短字段，用于控制或启用某些特殊属性。
- 记录长度，键的位置，键的长度只能出现在用关键字查找记录的文件里，它们提供了查找关键字所需的信息。

## 文件访问

### 顺序访问

- 从头按顺序存取文件的全部字节或记录。
- **不能跳过某些内容，可以返回到起点，或者多次存取。**
- 当存储介质为磁带时，顺序存取方式非常合适的。

### 随机访问

- **可以以任何次序存取文件的字节或者记录。**（不按顺序地读取，或按关键字访问记录）
- 对于数据库系统，这种存取方式是必不可少的
- 有两种方法可以指示从何处开始读写文件：
	- 每次读写操作都给出开始读写文件的位置
	- 用一个seek操作设置当前读写位置，然后从此位置开始顺序读写文件。

## 文件操作

- Create：创建不包含任何数据的文件。
	- **在外存中找到文件所需的空间**（结合空闲链表法、位示图、成组链接法等管理策略，找到空闲空间） ，根据文件存放路径的信息**找到该目录对应的目录文件**，**在目录中创建该文件对应的目录项**。目录项中包含了文件名、文件在外存中的存放位置等信息。
- Delete：删除文件释放磁盘空间
	- 根据**文件存放路径找到相应的目录文件**，从目录中**找到文件名对应的目录项**。
	- 根据该目录项记录的文件在外存的存放位置、文件大小等信息，**回收文件占用的磁盘块**。（回收磁盘块时，根据空闲表法、空闲链表法、位图法等管理策略的不同，需要做不同的处理）
	- **从目录表中删除文件对应的目录项**。
- Open：在使用文件之前，必须先打开文件。
	- 根据文件存放路径**找到相应的目录文件**，从目录中**找到文件名对应的目录项**，并**检查**该用户是否有指定的**操作权限**。
	- **将目录项复制到内存中的“打开文件表”中**。并将对应**表目的编号返回给用户**（**文件描述符**）。
	- 之后用户使用打开文件表的编号（**文件描述符**）来指明要操作的文件。
- **进程打开文件表**中特有的属性：**读写指针**、**访问权限**（只读？读写？）
- **系统打开文件表**中特有的属性：**计数器**（有多少个进程打开了该文件）
- Close：访问结束后，关闭文件释放内部表空间
	- 将进程的**打开文件表中相应表项删除**
	- **回收分配给该文件的内存空间等资源**
	- 系统打开文件表的**计数器**count减1，若count= 0，则删除对应表项。
- Read：在文件中读取数据
	- 操作系统在处理read系统调用时，会**从读指针指向的外存中，将用户指定大小的数据读入用户指定的内存区域中**。
- Write：向文件写数据
	- 操作系统在处理write系统调用时，**会从用户指定的内存区域中，将指定大小的数据写回写指针指向的外存。**
- Append：在文件末尾追加数据
- Seek：指定从何处开始读取数据
- Get Attributes：读取文件属性
- Set Attributes：设置文件属性
- Rename：重命名

# 目录

## 单级目录系统

- 目录的最简单形式是在一个目录中包含所有的文件，称为根目录。
- 单级目录实现了“按名存取”，**但是不允许文件重名**。
- 在创建一个文件时，需要先检查目录表中有没有重名文件，确定不重名后才能允许建立文件，并将新文件对应的目录项插入目录表中。
- 显然，**单级目录结构不适用于多用户操作系统**。

![kfJHEonBCWPLmul.png](https://s2.loli.net/2025/12/08/kfJHEonBCWPLmul.png)

## 二级目录结构

- 分为**主文件目录**和**用户文件目录**。
- 主文件目录：**记录用户名及相应用户文件目录的存放位置**
- 用户文件目录由该用户的文件FCB组成
- **允许不同用户的文件重名**。文件名虽然相同，但是对应的其实是不同的文件。
- 

## 层次目录系统

- 可以用很多目录对文件进行分组。
- **不同目录下的文件可以重名**。
![FnZhcvqu4z3Qwm9.png](https://s2.loli.net/2025/12/08/FnZhcvqu4z3Qwm9.png)

## 无环图目录结构

- 在树形目录结构的基础上，增加了一些**指向同一个节点**的有向边，目录成为**有向无环图**。
- 可以更方便的实现多个用户之间的**目录共享**。
- 可以用不同的文件名指向同一个文件，甚至可以指向同一个目录（共享同一目录下的所有内容）。
- **需要为每个共享结点设置一个共享计数器**，用于**记录此时有多少个地方在共享该结点**。用户提出删除结点的请求时，只是**删除该用户的FCB、并使共享计数器减1，并不会直接删除共享结点**。只有计数器为0时，，才会真正的删除。

# 索引节点

- 索引节点`i-node`，包含了FCB中除了文件名之外的文件描述信息
- 此时**目录项只要存储每个文件名和对应的索引节点指针**，使得一个盘块中的目录项更多，，减少了磁盘IO次数，**加快了文件检索速度**。
- 当找到文件名对应的目录项时，才需要将索引结点调入内存，索引结点中记录了文件的各种信息，包括文件在外存中的存放位置，根据“存放位置”即可找到文件。
- 存放在**外存中**的索引结点称为“**磁盘索引结点**”，当索引结点**放入内存**后称为“**内存索引结点**”。
- 相比之下**内存索引结点中需要增加一些信息**，比如：文件**是否被修改**、此时**有几个进程正在访问该文件**等。

# 路径名

- 用目录树组织文件系统时，需要用路径名指向特定文件。
- **绝对路径**：**从根目录到文件的路径组成**，如：`/usr/jim/aaa`
- **相对路径**：**即相对于当前工作目录的路径**。如果当前工作目录为`/usr/ast`，则`/usr/ast/aaa`的文件路径名可以写成相对路径`aaa`或`./aaa`


# 目录的实现

## 文件控制块

- FCB的有序集合称为“文件目录”，**一个FCB就是一个文件目录项。** 
- **FCB中包含了文件的基本信息**（文件名、物理地址、逻辑结构、物理结构等)，**存取控制信息**（是否可读/可写、禁止访问的用户名单等)，**使用信息**（如文件的建立时间、修改时间等

- 目录系统的主要功能是把文件名映射成定位文件数据所需的信息。

![VBrNmM78RDlEz2H.png](https://s2.loli.net/2025/12/15/VBrNmM78RDlEz2H.png)
## 简单设计方案(a)

- 目录有一个**固定大小**的目录项列表，每个文件对应一项（FCB）。包含一个固定长度的文件名，一个文件属性的结构体，以及用以说明磁盘块位置的磁盘地址。
- 特点：
	- **固定大小的目录项**
	- **目录项中包含文件的所有属性**

## 索引节点(i-node)方案(b)

- 文件名和其他属性分离，**目录项中只有文件名和文件索引节点号**。
- **文件的属性均在其对应的索引节点中**



# 文件系统布局

![FbAaONQtz34cEvf.png](https://s2.loli.net/2025/12/08/FbAaONQtz34cEvf.png)

- 磁盘的0号扇区为**主引导目录**（MBR），用来引导计算机。
- 在MBR的结尾是**分区表，给出了每个分区的起始和结束地址。** 表中的一个分区为活动分区。
- 在计算机被引导时，BIOS读入并执行MBR，MBR做的第一件事是确定活动分区，读入它的第一个块，称为引导块，并执行。引导块中的程序装载该分区的操作系统。
- 超级块(*superblock*)：包含文件系统的所有关键参数。
- 空闲块信息块：位图或指针列表
- i节点：说明了文件的各种信息，属性。
- 根目录/文件与目录。

# 文件的逻辑结构（用户级结构）

## 顺序文件


![hzQnUoturCTSLiJ.png](https://s2.loli.net/2026/01/07/hzQnUoturCTSLiJ.png)
- **文件中的记录一个接一个顺序排列。（逻辑上）**
- **串结构**：记录之间的顺序与关键字无关。
- **顺序结构**：记录之间的顺序按关键字排列。

## 索引文件

![Z8e15GkQpqTlShf.png](https://s2.loli.net/2026/01/07/Z8e15GkQpqTlShf.png)
- 建立**索引表**，每条记录对应一个索引项。
- 索引表本身是**定长记录的顺序文件**，可以随机访问，具有很快的检索速度。
- **可以将关键字作为索引表内容**，用多个不同的数据项建立多个索引表。

## 索引顺序文件

![Ted6SFMoHlmpDgU.png](https://s2.loli.net/2026/01/07/Ted6SFMoHlmpDgU.png)
- 将记录分组，建立索引表，**为一组记录设置一个索引表项**。
- **每个分组是一个顺序文件**。

## 多级索引顺序文件

- 当文件记录很多时，为了进一步提高检索效率，可以建立多级索引表。
![r8XfNdKWmT71RDi.png](https://s2.loli.net/2026/01/07/r8XfNdKWmT71RDi.png)

# 文件的实现（物理级结构）

## 磁盘块

类似于内存分页，**磁盘中的存储单元也会被分为一个个“块/磁盘块/物理块”**。很多操作系统中，**磁盘块的大小与内存块、页面的大小相同**


## 文件块

在外存管理中，为了方便对文件数据的管理，**文件的逻辑地址空间也被分为了一个一个的文件“块”**。于是文件的逻辑地址也可以表示为（逻辑块号，块内地址）的形式。

- 操作系统为文件分配存储空间都是以块为单位的
- 用户通过逻辑地址来操作自己的文件，**操作系统要负责实现从逻辑地址到物理地址的映射**

## 文件的实现

- 文件的物理结构是指**文件数据盘块在硬盘等存储介质中的组织方式**，有**连续存储方式和离散存储方式**两种。

### 连续分配

![qU6DFLbYVmMek8s.png](https://s2.loli.net/2025/12/08/qU6DFLbYVmMek8s.png)

- 把每一个文件作为**一连串连续数据块存储在磁盘上。**
- **优点**：
	- 实现简单，只需**记录第一块的磁盘地址和文件块数**即可。
	- **物理块号=起始块号+逻辑块号**
	- 相对于其他文件物理结构，**存取速度最快**。连续分配的文件在顺序读/写时速度最快。
	- 支持随机访问
- **缺点**：
	- 物理上采用连续分配,**存储空间利用率低**，会**产生难以利用的磁盘碎片**。可以用紧凑来处理碎片，但是需要耗费很大的时间代价。
	- **不支持文件的动态增长**

### 链表分配

![rNlU8pEdDmcFMfO.png](https://s2.loli.net/2025/12/08/rNlU8pEdDmcFMfO.png)

- 为每个文件构造**磁盘块链表**。**每个块的第一个字作为指向下一块的指针**，其他部分存放数据。
- 文件目录中**记录了文件存放的起始块号**。当然，也可以增加一个字段来表示文件的长度
- **优点**：
	- 采用离散式分配，能**充分利用磁盘空**间（**不产生外部碎片**，文件的最后一块可能有内部空余）。
	- **支持文件的动态增长**
- **缺点**：
	- **不支持随机访问**，因为**每一次必须从头开始一直读到想要读的那一块。**

### 使用内存中的表（文件分配表）进行分配

![IJa6Efx315KewyU.png](https://s2.loli.net/2025/12/08/IJa6Efx315KewyU.png)

- **取出每个磁盘块的指针字，把它们放在内存的一个表中。** 这个表就是**文件分配表**(File Allocation Table，FAT)
- **目录只要记录文件的起始块即可**。
- **一个磁盘仅设置一张FAT**。**开机时，将FAT读入内存，并常驻内存**。FAT的各个表项在物理上连续存储，且每一个表项长度相同，因此“物理块号”字段可以是隐含的。
- 利用文件分配表，可以直接找到对应文件的起始块，顺着链往下找即可找到全部文件。
- **逻辑块号转化为物理块号**：从目录项中找到起始块号，若`i>O`，则查询内存中的文件分配表FAT，往后找到i号逻辑块对应的物理块号，`i--`。
- **逻辑块号转换成物理块号的过程不需要读磁盘操作。**
- **优点**：
	- **支持随机访问**，访问效率高。不产生外部碎片，支持文件的动态增长
- **缺点**：
	- **必须把整个表存在内存中**，**对大型磁盘不能较好支持**。

### 索引文件分配

![tQqC2iJglvNzAcn.png](https://s2.loli.net/2025/12/08/tQqC2iJglvNzAcn.png)

- **给每个文件建立一个索引文件（索引表）**，记录了每个文件块的磁盘地址（物理块号）。
- **索引块**：存放索引表的磁盘块。
- **数据块**：存放文件数据的磁盘块。
- **目录需要记录文件的索引块的物理块号**。
- 根据索引文件，就可以找到文件的所有文件块。
- 访问逻辑块号i：从FCB找到文件索引表的位置，查索引表的第i项即可找到物理块号。
- 假设物理块大小为4KB，索引表指针为4个字节
	- **能管理的最大文件**：`1K(4KB/4个目录项)*4KB(每个目录项对应的物理块大小)=4MB`
	- 磁盘IO操作次数：`1(访问索引文件)+1(访问物理块)`

- 类似地，索引文件也可以建立多级索引文件。

![Q5vVt6DLBqmKU2E.png](https://s2.loli.net/2025/12/08/Q5vVt6DLBqmKU2E.png)
- 假设物理块大小为4KB，索引表指针为4个字节
	- **能管理的最大文件**：`1K(4KB/4 个二级索引项)*1K(4KB/4 个目录项)*4KB(每个目录项对应的物理块大小)=4GB`
	- 磁盘IO操作次数：`1(访问一级索引)+1(访问二级索引文件)+1(访问物理块)`
- 使用二级索引时，先算出需要查找的一级索引表的表项（逻辑块号/索引表长度）和二级索引表表项（逻辑块号%索引表长度），访问一次一级索引表和一次二级索引表，得到物理块号，访问对应的存储单元，**一共需要3次磁盘IO**（读入内存）
- 采用**K层索引**结构，且**顶级索引表未调入内存**，则**访问一个数据块只需要K+1次读磁盘操作**


### UNIX文件

 - 直接间接**混合寻址**方式
- 一共分为13个块：**前10个块为直接索引**，第**11为一级索引**，**12为二级索引**，**13为三级索引**
![SOBc6irVyHMQwP4.png](https://s2.loli.net/2025/12/08/SOBc6irVyHMQwP4.png)


## 文件的存取方法

![1HdfEQ3n8M6PwyX.png](https://s2.loli.net/2025/12/08/1HdfEQ3n8M6PwyX.png)


# 文件存储空间管理

## 存储空间的划分和初始化

- 存储空间的划分：**将物理磁盘划分为一个个文件卷**（逻辑卷、逻辑盘）
- 存储空间的初始化：**将各个文件卷划分为目录区、文件区**
- **目录区**：存储**文件目录信息**，**磁盘存储管理**所用信息
- 文件区：存放文件数据

## 存储空间管理

### 位示图法

![Jmir8u5PVwBhTvL.png](https://s2.loli.net/2026/01/07/Jmir8u5PVwBhTvL.png)

- **每个二进制位对应一个盘块**。在本例中，**“0”代表盘块空闲，“1”代表盘块已分配**。
- 位示图一般用连续的“字”来表示，如，一个字的字长是8位，字中的每一位对应一个盘块。因此可以用（字号，位号）对应一个盘块号。当然有的题目中也描述为（行号，列号）
- 数组元素$b_{ij}$所代表的块号为：$x=m*i+j$   ($m$为矩阵的列数，或字长)
- b号盘块对应的字号`i=b/n`，位号`j=b%n`
- 分配：若文件需要k个块，顺序扫描位示图，找到k个相邻或不相邻的“0”；**根据字号、位号算出对应的盘块号，将相应盘块分配给文件**；将**相应位设置为“1”**。
- 回收：根据回收的**盘块号计算出对应的字号、位号**；将**相应二进制位设为“0”**

### 空闲表法

![HDL2V5q3TprivYt.png](https://s2.loli.net/2026/01/07/HDL2V5q3TprivYt.png)
- 记录了一段**连续的空闲盘块**区间的**起始位置和长度**。
- 分配磁盘块：首次适应，最佳适应，最坏适应等
- 回收磁盘块：注意**回收区前后相邻是否有空闲区**，注意**空闲区的合并**

### 空闲链表法

#### 以盘块为单位

![xFs7vgbCowfMeWA.png](https://s2.loli.net/2026/01/07/xFs7vgbCowfMeWA.png)
- 操作系统保存头指针即可
- 分配：若某文件申请K个盘块，则**从链头开始依次摘下K个盘块分配**，并**修改空闲链的链头指针**。
- 回收：**回收的盘块依次挂到链尾**。


#### 以连续的空闲块成组为单位

- 操作系统记录头指针。
- **分配**：
	- 若某文件申请K个盘块，则可以采用首次适应、最佳适应等算法，从链头开始检索，按照算法规则找到一个大小符合要求的空闲盘区，分配给文件。
	- 若没有合适的连续空闲块，也可以**将不同盘区的盘块同时分配给一个文件**，注意分配后可能要修改相应的链指针、盘区大小等数据。
- **回收**：
	- 若回收区**和某个空闲盘区相邻**，则需要将**回收区合并**到空闲盘区中。
	- 若回收区没有和任何空闲区相邻，将回收区作为**单独的一个空闲盘区挂到链尾**。

### 成组连接法

![WdQxtDl3OwykaMC.png](https://s2.loli.net/2026/01/07/WdQxtDl3OwykaMC.png)

- 核心思路：将空闲块分成若干组，每组 100 个（假设），并像链条一样把这些组串起来，但只在内存中维护“当前这一组”的信息。
- 文件卷的目录区中专门用一个磁盘块作为“**超级块**”，当系统启动时需要将超级块读入内存。并且要保证内存与外存中的“超级块”数据一致。
- 系统启动时，将**第一组**的信息（包含 100 个空闲块号的栈）读入内存中的专用区域——**超级块**。所有的分配和回收操作，优先在超级块的内存中进行，速度极快。

- 在内存的**超级块**中，维护着两个关键数据（可以理解为一个**栈**）：
	1. **`s_n` (计数器)：** 记录**当前组中可用的空闲块数量**。
	2. **`s_free[100]` (地址栈)：** 一个数组，存放当前**这一组所有空闲块的物理地址。**
	3. 这一组的**第一个磁盘块存放着下一组的块的地址信息**。

- 分配：
	- 若当前分组的空闲块数足够： 从 `s_free` 数组中取出一个地址分配给用户， 将 `s_n` 减 1。
	- 若**当前组只剩最后一个块 (`s_n == 1`)** 这是临界情况：读取该块（第一块）的内容（即下一组的索引表），将读取到的下一组信息**复制**（计数器和地址数组）覆盖**到内存的超级块中**，将第一块分配给用户使用。
- 回收：
	- 当前组未满：将释放的块号填入当前分组， 将 `s_n` 加 1。
	- **当前组已满**：将内存超级块中现有的 `s_n` 和 `s_free` 数据，**写入**到刚刚释放的这个新块中，将超级块的 `s_n` 重置为 `1`，第一个盘块指向这个刚刚释放（现在已存满索引信息）的块号。

# 共享文件

多个用户共享同一个文件，意味着系统中只有“一份”文件数据。并且**只要某个用户修改了该文件的数据，其他用户也可以看到文件数据的变化。**（区别于复制文件的概念）

## 硬链接

- 基于索引节点，索引结点中**设置一个链接计数变量count**，用于**表示链接到本索引结点上的用户目录项数**。
- **以不同的文件路径名共享**一个文件副本，**不额外占用磁盘空间**。
- **不允许给目录创建硬链接**
- 硬链接**只有在同一个文件系统(同一分区内)中才能创建**
- `ln 源文件 目标文件`
![WzhLDnYa9XBUilA.png](https://s2.loli.net/2026/01/07/WzhLDnYa9XBUilA.png)


## 软链接(符号链接)

- 建立一个Link类型的文件，**记录了文件的存放路径**。类似于windos快捷方式。
- 当User3访问“ccc”时，操作系统判断文件“ccc”属于Link类型文件，**于是会根据其中记录的路径层层查找目录，最终找到User1的目录表中的“aaa”表项**，于是就找到了文件1的索引结点。
- **以路径的形式存在**，类似于Windows中的快捷方式。
- 软链接**可以跨文件系统** ，硬链接不可以。
- 软链接**可以对一个不存在的文件名进行链接**
- 软链接**可以对目录进行链接**
- `ln -s 源文件 目标文件`

